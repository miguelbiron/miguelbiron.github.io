<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>Miguel Biron-Lattes</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>
    
    
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/xcode.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

    
    
    

    
    <link type="text/css" rel="stylesheet" href="/css/custom.css">
 
    
    
</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">Miguel Biron-Lattes</a>
    </div>  
</header>
  <div class="nav-menu">
  
    <a class="color-link nav-link" href="/post/">Blog</a>
  
    <a class="color-link nav-link" href="/tags/">Tags</a>
  
    <a class="color-link nav-link" href="/archives/">Archives</a>
  
  <a class="color-link nav-link" href="/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:miguel.biron@stat.ubc.ca" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://linkedin.com/in/miguelbiron" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/miguelbiron" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://stackoverflow.com/users/5443023" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    
</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">Simplifying payments with linear programming</h1>
    
    <time>February 9, 2018</time>
    
    <div>
        <p>
        


<p><em>Update: I have built <a href="/post/2018-02-17-demo-simple-payments/">a demo webapp</a> implementing the solution presented here. You should try it!</em></p>
<p>Imagine you have a group of <code>$n$</code> friends and that you regularly go out for drinks with them (say, a couple of times a week). At each of these meetings, a different member of the group pays for the bill, but you keep track of who consumed what (by using one of these popular <a href="http://www.businessinsider.com/5-apps-that-take-the-pain-out-of-splitting-the-bill-2016-1/#-3">apps</a>, for example). You can expect that, after a month or so, everyone is going to owe everyone some amount of money. Settling these debts will involve a cumbersome sequence of up to <code>$n(n-1)$</code> payments from each member to another. The question which obviously arises is then:</p>
<blockquote>
<p>Can we reduce the number of transactions to a minimum while ensuring that everyone gets paid what he or she is owed?</p>
</blockquote>
<p>The answer yes, but finding the optimal solution can take you <strong>a lot of time</strong>. As has been noted <a href="https://hackernoon.com/adventures-in-programming-interviews-misleadingly-difficult-np-hard-problem-43092597018c">elsewhere</a>, this seemingly inoffensive problem is actually <strong>NP-hard</strong>. Many people have proposed many different heuristics to approach this problem (see this <a href="https://stackoverflow.com/q/877728/5443023">Stackoverflow question</a>). My problem with these solutions is simply that they are not as elegant as I would like them to be.</p>
<div id="linear-programming" class="section level2">
<h2>Linear programming</h2>
<p>In this post, I am going to show you a completely different approach to solve this problem by using <strong><a href="https://en.wikipedia.org/wiki/Linear_programming">Linear Programming</a></strong>. A standard formulation of an LP is: <code>$$ \begin{aligned} &amp; \min_{x \in \mathbb{R}^N} &amp; &amp; c^Tx \\ &amp; \text{s.t} &amp; &amp; Ax \leq b \\ &amp;&amp;&amp; x \geq 0 \end{aligned} $$</code></p>
<p>where <code>$c \in \mathbb{R}^N$</code>, <code>$A$</code> is matrix of size <code>$m \times N$</code> and <code>$b \in \mathbb{R}^m$</code> (<code>$\geq$</code> and <code>$\leq$</code> work as element-wise inequalities). LP is a mature technology, with many solvers available under both commercial and open source licenses, that can solve problems involving thousands of variables using a desktop computer in under a minute <span class="citation">(Boyd and Vandenberghe 2004)</span>. In what follows, I will show you how to leverage this technology to solve the problem we are tackling.</p>
</div>
<div id="mathematical-formulation-of-the-problem" class="section level2">
<h2>Mathematical formulation of the problem</h2>
<p>We will describe the debts within the group by a matrix <code>$D$</code> such that <code>$d_{ij} \geq 0$</code> is the amount of money that the <code>$i$</code>-th member owes to the <code>$j$</code>-th member: <code>$$ D =  \begin{pmatrix} 0 &amp; d_{12} &amp; \dots &amp; d_{1N} \\ d_{21} &amp; 0 &amp; \dots &amp; d_{2N} \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\ d_{N1} &amp; \dots &amp; d_{NN-1}&amp; 0 \end{pmatrix} $$</code></p>
<p>The diagonal is full of 0’s because nobody owes himself, but other than that, we are assuming that this matrix is very dense, so that <code>$d_{ij} &gt; 0$</code> for most of the <code>$i \neq j$</code> pairs.</p>
<p>Under this description, our aim is then to find a different matrix <code>$X$</code> that has the least possible number of entries <code>$x_{ij} &gt; 0$</code>, but that satisfies the constraint imposed by the problem. The constraints can be cast as <code>$$ \forall i: \underbrace{\sum_j x_{ji}}_{\text{owed to }i\text{ under }X} - \underbrace{\sum_j x_{ij}}_{\text{owed by }i\text{ under }X} = \underbrace{\sum_j d_{ji}}_{\text{owed to }i\text{ under }D} - \underbrace{\sum_j d_{ij}}_{\text{owed by }i\text{ under }D} $$</code></p>
<p>We can express this succinctly using linear algebra: <code>$$ (X^T - X)1_n = (D^T - D)1_n $$</code></p>
<p>Note that the function <code>$f_c(X) = (X^T - X)c$</code> is linear in <code>$X$</code>, <code>$\forall c \in \mathbb{R}^n$</code>, since <code>$\forall \alpha, \beta \in \mathbb{R}$</code>: <code>$$ \begin{aligned} f_c(\alpha X + \beta Y) &amp;= [(\alpha X + \beta Y)^T - (\alpha X + \beta Y)]c \\ &amp;= \alpha(X^T - X)c + \beta(Y^T - Y)c \\ &amp;= \alpha f_c(X) + \beta f_c(Y) \end{aligned} $$</code></p>
<p>Using the above definitions, we can now formally state our optimization problem <code>$$ \begin{aligned} &amp; \min_{X \in \mathbb{R}^{n\times n}} &amp; &amp; \|X\|_0 \\ &amp; \text{s.t} &amp; &amp; (X^T - X)1_n = b \\ &amp;&amp;&amp; x_{ii} = 0, \forall i \\ &amp;&amp;&amp; x_{ij} \geq 0, \forall i \neq j \end{aligned} $$</code></p>
<p>where we have defined <code>$r \triangleq (D^T - D)1_n$</code>, to highlight the fact that this is the only way our problem depends on <code>$D$</code>. In other words, we could do the same analysis if someone gave us <code>$b$</code> instead of <code>$D$</code>. Also, <code>$\|X\|_0$</code> is the number of non-zero components in <code>$X$</code>.</p>
<p>Now, if we wanted to say that this looks like an LP, we would run into two issues:</p>
<ol style="list-style-type: decimal">
<li><code>$X$</code> is a matrix, not a vector</li>
<li><code>$\|\cdot\|_0$</code> is not a linear function (nor differentiable, nor continuous)</li>
</ol>
<p>The first issue is actually easier to deal with, so we’ll start with that one.</p>
</div>
<div id="thinking-in-terms-of-vectors-instead-of-matrices" class="section level2">
<h2>Thinking in terms of vectors instead of matrices</h2>
<p>As you may know from linear algebra courses, the space of matrices with real entries of size <code>$r\times c$</code>, <code>$\mathbb{R}^{r\times c}$</code>, is isomorphic to <code>$\mathbb{R}^{rc}$</code>. One isomorphism is the function: <code>$$ vec: \mathbb{R}^{r\times c} \to \mathbb{R}^{rc} $$</code></p>
<p>such that <code>$\forall M \in \mathbb{R}^{r\times c}$</code>, <code>$v = vec(M)$</code> is a vector of size <code>$rc$</code> formed by stacking the columns of <code>$M$</code>.</p>
<p>Given the above, we could therefore work with <code>$x = vec(X)$</code>. Since this is an isomorphism, and the restriction is linear in <code>$X$</code>, we know that: <code>$$ \exists A \in \mathbb{R}^{n\times n^2}, \forall X \in \mathbb{R}^{n\times n}: Avec(X) = (X^T - X)1_n $$</code></p>
<p>This is all good, but we could further exploit the structure of the problem in order to make this translation into vectors more efficient. Indeed, recall that we are looking for a matrix with a diagonal of zeroes. Therefore, instead of working with vectors in <code>$\mathbb{R}^{n^2}$</code> and setting up restrictions for enforcing a zero diagonal, we could just remove the diagonal from our vector representation. This way, we reduce the number of degrees of freedom and the number of restrictions.</p>
<p>Thus, let us define the function <code>$$ vec^*: \mathbb{R}^{n\times n} \to \mathbb{R}^{n(n-1)} $$</code></p>
<p>such that <code>$v = vec^*(M)$</code> is a vector of size <code>$n(n-1)$</code> where the columns of <code>$M$</code> are stacked on top of one another, but the elements of the diagonal are removed. If we restrict the domain of <code>$vec^*$</code> to the set <code>$$ \mathcal{D}_0 = \{M \in \mathbb{R}^{n\times n}: \text{diag}(M) = 0_n\} $$</code></p>
<p>then <code>$$ vec^*: \mathcal{D}_0 \to \mathbb{R}^{n(n-1)} $$</code></p>
<p>is an isomorphism. Hence, <code>$$ \exists A \in \mathbb{R}^{n\times n(n-1)}, \forall X \in \mathcal{D}_0: Avec^*(X) = (X^T - X)1_n $$</code></p>
<p>Indeed, the matrix <code>$A$</code> can be constructed for any <code>$n \geq 2$</code>. I have built an R package that implements the approach I describe in this blog called <code>minTX</code> and which is available from <a href="https://github.com/miguelbiron/minTX">Github</a>. It uses the <code>lpSolve</code> package, which is an interface to the <code>lp_solve</code> solver. <code>minTX</code> also has all the helper functions needed for the matrix &lt;-&gt; vector conversions and for building the constraint matrix. So, let me show you how <code>$A$</code> looks like for <code>$n=3$</code>:</p>
<pre class="r"><code>library(minTX)

n = 3
A = get_const_matrix(n)
A
##      [,1] [,2] [,3] [,4] [,5] [,6]
## [1,]    1    1   -1    0   -1    0
## [2,]   -1    0    1    1    0   -1
## [3,]    0   -1    0   -1    1    1</code></pre>
<p>Let’s check that this weird construction works as it should</p>
<pre class="r"><code># get a random matrix with positive coefficients and diag = 0
M = matrix(rexp(n*n, 0.1), nrow = n); diag(M) = rep(0, n)
all.equal(colSums(M) - rowSums(M), as.vector(A %*% mat_2_vec(M)))
## [1] TRUE</code></pre>
<p>And the same, but for <code>$n = 20$</code>:</p>
<pre class="r"><code>n = 20
M = matrix(rexp(n*n, 0.1), nrow = n); diag(M) = rep(0, n)
all.equal(colSums(M) - rowSums(M), as.vector(get_const_matrix(n) %*% mat_2_vec(M)))
## [1] TRUE</code></pre>
</div>
<div id="from-a-nonlinear-target-to-a-linear-one" class="section level2">
<h2>From a nonlinear target to a linear one</h2>
<p>Okay, so we’ve managed to go from matrices to vectors, so that our optimization problem now looks like: <code>$$ \begin{aligned} &amp; \min_{x \in \mathbb{R}^{n(n-1)}} &amp; &amp; \|x\|_0 \\ &amp; \text{s.t} &amp; &amp; Ax = b \\ &amp;&amp;&amp; x \geq 0 \end{aligned} $$</code></p>
<p>The fact that the constraint is expressed as an equality is of no concern, because one can always express an equality as a pair of inequalities.</p>
<p>Now, in order to deal with the fact that the target is nonlinear, we will introduce the following change in the objective function: <code>$$ \begin{aligned} &amp; \min_{x \in \mathbb{R}^{n(n-1)}} &amp; &amp; \|x\|_1 \\ &amp; \text{s.t} &amp; &amp; Ax = b \\ &amp;&amp;&amp; x \geq 0 \end{aligned} $$</code></p>
<p>where <code>$\|\cdot\|_1$</code> is the <code>$L^1$</code>-norm. Since we require that <code>$x \geq 0$</code>, we can again rewrite this as <code>$$ \begin{aligned} &amp; \min_{x \in \mathbb{R}^{n(n-1)}} &amp; &amp; c^T x \\ &amp; \text{s.t} &amp; &amp; Ax = b \\ &amp;&amp;&amp; x \geq 0 \end{aligned} $$</code></p>
<p>with <code>$c = 1_{n(n-1)}$</code>. This is now <strong>a linear program</strong>.</p>
<p>It also a <em>fundamentally different</em> problem: we are now minimizing the <strong>total amount of transactions</strong>, which is of course not the same as minimizing the <strong>total number of transactions</strong>.</p>
<p>However, the work by <span class="citation">Donoho and Tanner (2005)</span> gives an answer: if there exists a <em>sufficiently sparse</em> representation for <code>$x$</code>, then the solution to both problems is the same. This is one of many results of the much interesting field of <a href="https://en.wikipedia.org/wiki/Compressed_sensing">Compressed Sensing</a>, of which I know very little of, so I am not even going to try to give an introduction. However, if you are familiar with the <a href="https://en.wikipedia.org/wiki/Lasso_(statistics)">Lasso</a> technique in statistics, you might get a sense of what is going on under the hood here.</p>
</div>
<div id="experiments" class="section level2">
<h2>Experiments!</h2>
<div id="circular-debts" class="section level3">
<h3>Circular debts</h3>
<p>In this case, we assume that the matrix <code>$D$</code> is such that we can find a circular arrangement of the participants in which every person pays an amount <code>$s$</code> to the person in front, and therefore receives the same amount from the person behind. We know in advance that the optimal solution to this system is that no transaction needs to be made.</p>
<pre class="r"><code>suppressPackageStartupMessages(library(igraph))
suppressPackageStartupMessages(library(ggraph))

# function to obtain circular payment matrix
get_cir_D = function(n, s){
  D = rbind(cbind(rep(0, n-1), s*diag(n-1)), rep(0,n))
  D[n,1] = s
  return(D)
}

# make and plot matrix of size 8
n = 8; s = 10
D = get_cir_D(n, s)

graph_from_adjacency_matrix(D, mode = &quot;directed&quot;, weighted = TRUE) %&gt;% 
  ggraph(layout = &quot;circle&quot;) +
  geom_edge_link(aes(label = weight), angle_calc = &#39;along&#39;, label_dodge = unit(2.5, &#39;mm&#39;), arrow = arrow(length = unit(4, &#39;mm&#39;))) + 
  geom_node_point(size = 5) +
  theme_graph()</code></pre>
<p><img src="/post/2018-02-09-simplifying-pmts-with-LP_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Let’s see if our procedure finds the optimal allocation</p>
<pre class="r"><code>solve_min_TX(D)
## Success: the objective function is 0
##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]    0    0    0    0    0    0    0    0
## [2,]    0    0    0    0    0    0    0    0
## [3,]    0    0    0    0    0    0    0    0
## [4,]    0    0    0    0    0    0    0    0
## [5,]    0    0    0    0    0    0    0    0
## [6,]    0    0    0    0    0    0    0    0
## [7,]    0    0    0    0    0    0    0    0
## [8,]    0    0    0    0    0    0    0    0</code></pre>
<p>Great! The solution found by <code>minTX</code> is indeed the optimal one.</p>
</div>
<div id="dense-payment-matrix" class="section level3">
<h3>Dense payment matrix</h3>
<p>Now, let us try with a dense matrix:</p>
<pre class="r"><code>set.seed(1313)

# function to obtain a random dense payment matrix
get_dense_D = function(n, s){
  D = matrix(rexp(n*n, 1/s), nrow = n)
  diag(D) = rep(0, n)
  return(D)
}

# make and plot matrix of size 8
D = get_dense_D(n, s)

graph_from_adjacency_matrix(D, mode = &quot;directed&quot;, weighted = TRUE) %&gt;% 
  ggraph(layout = &quot;circle&quot;) +
  geom_edge_link(aes(label = format.default(weight, digits = 1)), angle_calc = &#39;along&#39;, label_dodge = unit(2.5, &#39;mm&#39;), arrow = arrow(length = unit(4, &#39;mm&#39;))) + 
  geom_node_point(size = 5) +
  theme_graph()</code></pre>
<p><img src="/post/2018-02-09-simplifying-pmts-with-LP_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>It’s a mess, of course! Again, lets solve this using our procedure, making sure that it returns a valid payments matrix:</p>
<pre class="r"><code>X = solve_min_TX(D)
## Success: the objective function is 151.0473
all.equal(colSums(D) - rowSums(D), colSums(X) - rowSums(X))
## [1] TRUE</code></pre>
<p>Okay, now let’s take a look at the graph implied by the matrix produced by <code>minTX</code>:</p>
<pre class="r"><code>graph_from_adjacency_matrix(X, mode = &quot;directed&quot;, weighted = TRUE) %&gt;% 
  ggraph(layout = &quot;circle&quot;) +
  geom_edge_link(aes(label = format.default(weight, digits = 1)), angle_calc = &#39;along&#39;, label_dodge = unit(2.5, &#39;mm&#39;), arrow = arrow(length = unit(4, &#39;mm&#39;))) + 
  geom_node_point(size = 5) +
  theme_graph()</code></pre>
<p><img src="/post/2018-02-09-simplifying-pmts-with-LP_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Much simpler than before, isn’t it? In fact, we went down from 56 to barely 7 payments!</p>
<p>Let’s try the same dense matrix setup, but now with many more participants, and see how long it takes for our procedure to find a solution</p>
<pre class="r"><code>n = 100

# make matrix
D = get_dense_D(n, s)

# solve
start.time = Sys.time()
X = solve_min_TX(D)
## Success: the objective function is 6407.031
print(Sys.time() - start.time)
## Time difference of 0.5953553 secs</code></pre>
<p>Now, we went down from 9900 to 99 payments. And just to make sure, lets check the consistency:</p>
<pre class="r"><code>all.equal(colSums(D) - rowSums(D), colSums(X) - rowSums(X))
## [1] TRUE</code></pre>
</div>
</div>
<div id="conclusions-and-future-work" class="section level2">
<h2>Conclusions and future work</h2>
<p>In this post I have demonstrated a different approach to the problem of minimizing the number of payments between a set of counterparties, by leveraging the power of widely available LP solvers. I believe that this approach is valuable because it has the potential to scale to thousands of participants if we exploited the sparsity of the constraint matrix.</p>
<p>In the future, I would like to give more formal guarantees on the ability of the procedure to recover the sparsest solution. I would also like to improve the computational implementation, which is still very naive.</p>
<p>If you are interested in discussing about this, feel free to leave a comment and/or to contact me.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-boyd2004convex">
<p>Boyd, Stephen, and Lieven Vandenberghe. 2004. <em>Convex Optimization</em>. Cambridge university press.</p>
</div>
<div id="ref-donoho2005sparse">
<p>Donoho, David L, and Jared Tanner. 2005. “Sparse Nonnegative Solution of Underdetermined Linear Equations by Linear Programming.” <em>Proceedings of the National Academy of Sciences of the United States of America</em> 102 (27). National Acad Sciences: 9446–51.</p>
</div>
</div>
</div>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "the-mblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="page-footer">
        <hr class="footer-divider">
        
        
            <a class="tag" href="/tags/finance">#finance</a>
        
            <a class="tag" href="/tags/linear-programming">#linear programming</a>
        
            <a class="tag" href="/tags/r">#R</a>
        
      
    </div>


        

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


<script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>



<script src="/js/math-code.js"></script>


<script>
      renderMathInElement(
          document.body,
          {
              delimiters: [
                  {left: "$$", right: "$$", display: true},
                  {left: "\\[", right: "\\]", display: true},
                  {left: "$", right: "$", display: false},
                  {left: "\\(", right: "\\)", display: false}
              ]
          }
      );
</script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        
    <a class="social-icon" href="mailto:miguel.biron@stat.ubc.ca" target="_blank" rel="noopener" title="Email">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M25.2794292,5.59128519 L14,16.8707144 L2.72057081,5.59128519 C3.06733103,5.30237414 3.51336915,5.12857603 4,5.12857603 L24,5.12857603 C24.4866308,5.12857603 24.932669,5.30237414 25.2794292,5.59128519 Z M25.9956978,6.99633695 C25.998551,7.04004843 26,7.08414302 26,7.12857603 L26,20.871424 C26,21.0798433 25.9681197,21.2808166 25.9089697,21.4697335 L18.7156355,14.2763993 L25.9956978,6.99633695 Z M24.9498374,22.6319215 C24.6672737,22.7846939 24.3437653,22.871424 24,22.871424 L4,22.871424 C3.5268522,22.871424 3.09207889,22.7071233 2.74962118,22.432463 L10.0950247,15.0870594 L13.9848068,18.9768415 L14.1878486,18.7737996 L14.2030419,18.7889929 L17.6549753,15.3370594 L24.9498374,22.6319215 Z M2.00810114,21.0526627 C2.00273908,20.9929669 2,20.9325153 2,20.871424 L2,7.12857603 C2,7.08414302 2.00144896,7.04004843 2.00430222,6.99633695 L9.03436454,14.0263993 L2.00810114,21.0526627 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    

    

    

    
    <a class="social-icon" href="https://linkedin.com/in/miguelbiron" target="_blank" rel="noopener" title="LinkedIn">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M2,3.654102 C2,2.69908141 2.79442509,1.92397846 3.77383592,1.92397846 L24.2261641,1.92397846 C25.2058917,1.92397846 26,2.69908141 26,3.654102 L26,24.3462148 C26,25.3015521 25.2058917,26.0760215 24.2261641,26.0760215 L3.77383592,26.0760215 C2.79442509,26.0760215 2,25.3015521 2,24.3465315 L2,3.65378524 L2,3.654102 Z M9.27526132,22.1415901 L9.27526132,11.2356668 L5.65030092,11.2356668 L5.65030092,22.1415901 L9.27557808,22.1415901 L9.27526132,22.1415901 Z M7.46341463,9.74691162 C8.72727273,9.74691162 9.51409566,8.90940767 9.51409566,7.86284447 C9.49033893,6.79252455 8.72727273,5.97846056 7.48748812,5.97846056 C6.24675325,5.97846056 5.43649034,6.79252455 5.43649034,7.86284447 C5.43649034,8.90940767 6.22299652,9.74691162 7.4396579,9.74691162 L7.46309788,9.74691162 L7.46341463,9.74691162 Z M11.2815965,22.1415901 L14.9062401,22.1415901 L14.9062401,16.0519481 C14.9062401,15.7263225 14.9299968,15.4000634 15.0256573,15.1675641 C15.2876148,14.5159962 15.8840672,13.8416218 16.8856509,13.8416218 C18.1970225,13.8416218 18.7218879,14.8416218 18.7218879,16.3078872 L18.7218879,22.1415901 L22.3465315,22.1415901 L22.3465315,15.8885017 C22.3465315,12.5388027 20.5584416,10.9800443 18.1735825,10.9800443 C16.2182452,10.9800443 15.3595185,12.072854 14.8824834,12.8172315 L14.9065569,12.8172315 L14.9065569,11.2359835 L11.2819132,11.2359835 C11.3291099,12.2591067 11.2815965,22.1419069 11.2815965,22.1419069 L11.2815965,22.1415901 Z"></path>
        </svg>
    </a>
    

    

    

    

    

    

    

    
    
    
    <a class="social-icon" href="https://github.com/miguelbiron" target="_blank" rel="noopener" title="GitHub">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M13.9988029,1.32087331 C6.82105037,1.32087331 1,7.14112562 1,14.3212723 C1,20.0649109 4.72454649,24.9370678 9.89038951,26.6560892 C10.5408085,26.7757983 10.7778323,26.374374 10.7778323,26.0296121 C10.7778323,25.7215609 10.7666595,24.9035493 10.760275,23.8189856 C7.14426471,24.6042767 6.38131925,22.0760223 6.38131925,22.0760223 C5.78995672,20.5740732 4.93762853,20.1742451 4.93762853,20.1742451 C3.75729765,19.3682044 5.02701126,19.3841656 5.02701126,19.3841656 C6.33183953,19.4759425 7.01817121,20.7241085 7.01817121,20.7241085 C8.17775254,22.7104801 10.0611744,22.1366749 10.8017741,21.8038838 C10.919887,20.9643246 11.2558703,20.3913175 11.6269683,20.066507 C8.74038491,19.7385043 5.70536235,18.6228163 5.70536235,13.6413251 C5.70536235,12.2223743 6.21213051,11.0611968 7.04370914,10.1530044 C6.90963504,9.82420367 6.46351945,8.50181809 7.17139875,6.71256734 C7.17139875,6.71256734 8.26234691,6.36301702 10.7459099,8.04532771 C11.78259,7.75642995 12.8950858,7.61277914 14.000399,7.60719272 C15.1049142,7.61277914 16.2166119,7.75642995 17.2548881,8.04532771 C19.736855,6.36301702 20.8262071,6.71256734 20.8262071,6.71256734 C21.5356825,8.50181809 21.0895669,9.82420367 20.9562909,10.1530044 C21.7894656,11.0611968 22.2922435,12.2223743 22.2922435,13.6413251 C22.2922435,18.6355852 19.2524325,19.734514 16.3570705,20.0561322 C16.8231376,20.4575564 17.2389269,21.2508282 17.2389269,22.4638795 C17.2389269,24.2012564 17.2229657,25.603448 17.2229657,26.0296121 C17.2229657,26.3775663 17.4575954,26.7821827 18.116793,26.6552912 C23.2786458,24.9322794 27,20.0633148 27,14.3212723 C27,7.14112562 21.1789496,1.32087331 13.9988029,1.32087331"></path>
        </svg>
    </a>
    

    
    <a class="social-icon" href="https://stackoverflow.com/users/5443023" target="_blank" rel="noopener" title="Stack Overflow">
        <svg width="28px" height="28px" viewBox="0 0 28 28" version="1.1" fill="#ABABAB" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path d="M20.8863636,23.7090909 L20.8863636,17.3818182 L22.9863636,17.3818182 L22.9863636,25.8090909 L4.03181818,25.8090909 L4.03181818,17.3818182 L6.13181818,17.3818182 L6.13181818,23.7090909 L20.8863636,23.7090909 Z M8.45,16.7818182 L8.88636364,14.7090909 L19.1954545,16.8636364 L18.7590909,18.9363636 L8.45,16.7818182 Z M9.81363636,11.8727273 L10.6863636,9.93636364 L20.2318182,14.4090909 L19.3590909,16.3181818 L9.81363636,11.8727273 Z M12.4590909,7.18181818 L13.7954545,5.57272727 L21.8954545,12.3090909 L20.5590909,13.9181818 L12.4590909,7.18181818 Z M17.6954545,2.19090909 L23.9681818,10.6454545 L22.2772727,11.9 L16.0045455,3.44545455 L17.6954545,2.19090909 Z M8.23181818,21.5818182 L8.23181818,19.4818182 L18.7590909,19.4818182 L18.7590909,21.5818182 L8.23181818,21.5818182 Z"></path>
        </svg>
    </a>
    
    
    

    
</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>